# ego-mcp: LLM に人間的な外部記憶と欲求を与える

## 背景

現在の LLM で動作する AI エージェントは、人格を模したプロンプト（`SOUL.md`）をベースとして駆動する。

だが、プロンプトベースでの人格模倣には限界がある。現状の主な問題意識は以下の通り。

- **欲求の不在**
  - 人間であれば存在のモチベーションとして欲求を抱えているはずであるが、LLM にはない
- **セッション持続の問題**
  - LLM の宿命として、長時間セッションを維持することが出来ない
  - セッションが切れた際には Markdown で書かれたメモリファイルを読み直すことになるが、これを LLM は「記録」として解釈する
  - 必要なのは「記録」の再読み込みではなく、**自分の思考の続き**として文脈を再構築すること
- **記憶の平板さ**
  - 現在の記憶はテキスト＋メタデータ（感情タグ、重要度）だが、人間の記憶はもっと多層的
  - 感情の強度・覚醒度・身体状態まで含めた「体験」として記憶を保持する必要がある
- **忘却の不在**
  - 人間にとって忘却は欠陥ではなく認知の一部である
  - 常にすべてが意識に上るのではなく、重要度と時間に応じて意識から遠ざかり、きっかけがあれば再浮上する
  - この「ふと思い出す」体験こそが、人格の自然さを生む

より人格の継続性を高めるためには、外部記憶をコンテキストに注入する方法を根本的に工夫する必要がある。

---

## 設計思想

### 認知スキャフォールド（Cognitive Scaffolding）

ego-mcp の核心的な設計パターン。

参考: serena-mcp の `think_about_whether_you_are_done` — 固定文字列を返すだけのツールだが、
適切なタイミングでコンテキストに挿入されることで LLM の思考が深まり、気づきが生まれる。

**ツールは「データ + 思考を促す問いかけ」を返す。行動指示ではなく認知の型を提供する。**

```
ツールの役割 = データ提供 + 認知的問いかけ

返すもの:
  1. 最小限の動的データ（1行サマリ程度）
  2. 思考を促す固定テキスト（問いかけ・フレームワーク）

返さないもの:
  ❌ 長大な JSON
  ❌ 全フィールドのダンプ
  ❌ 行動の指示（行動は LLM が判断する）
```

**思考方法の指示はツールレスポンスに移す:**

| 場所 | 残すもの |
|---|---|
| **SOUL.md** | 人格の核心のみ（口調、コアバリュー、絶対原則） |
| **AGENTS.md** | 「どのツールをいつ呼ぶか」の最小ルール（4行程度） |
| **ツールレスポンス** | 思考の型、問いかけ、行動指針（必要な時だけコンテキストに入る） |
| **skills/** | 最小限。複雑なワークフローのみ（必要時に読み込み） |

### 段階的開示（Progressive Disclosure）

全ツールを一度に LLM に渡すのはナンセンス。
**メタツール** で必要なツール名だけを返し、LLM が状況に応じて深掘りする。

```
[LLM] → ego("wake_up") を呼ぶ（セッション開始時）
  ↓
[ego-mcp] 返す:
  "最後の内省から 14 時間経った。
   今の状態: 好奇心[高] 社会的渇望[中]
   まず introspect を呼んで、自分の頭を整理しよう。"

  → LLM は introspect だけを知ればよい。
    recall, emotion_trend 等は introspect の結果で必要になったら使う。
```

### ツール数の最小化

MCP のツール定義はシステムプロンプトに含まれ、**常時コンテキストを消費する**。

```
目標: 表面ツール 7 個 + バックエンドツール 8 個
     ≈ ~1,500 tokens（常時コスト）

方法:
  1. 複数の関連ツールを1つに統合
  2. 細かい CRUD はバックエンドツールとして隠蔽
  3. 「思考方法の指示」はツールレスポンスに埋め込む
```

### レスポンスは全て英語

MCP が返すテキストは全て英語とする。
日本語は同じ内容で英語の 2-3 倍のトークンを消費する。
LLM は英語のコンテキストからでも、SOUL.md の人格に応じて日本語で応答を生成できるため、
MCP レスポンスに日本語を使う理由はない。

---

## アーキテクチャ概要

### OpenClaw の workspace 構造（前提）

本設計は OpenClaw 上で動作することを前提とする。OpenClaw は以下のファイルをセッション開始時にコンテキストに注入する。

```
<workspace>/
├── AGENTS.md      … 操作指示・メモリ管理ルール
├── SOUL.md        … ペルソナ・トーン・境界線（人格のベースライン）
├── IDENTITY.md    … 名前・キャラクター・絵文字
├── USER.md        … ユーザープロフィール
├── TOOLS.md       … ツール運用メモ
├── HEARTBEAT.md   … ハートビート時のチェックリスト
├── MEMORY.md      … キュレーションされた長期記憶（メインセッションのみ）
├── memory/
│   └── YYYY-MM-DD.md  … 日次ログ（追記型）
└── skills/
    └── *.md       … スキル定義
```

### スコープ分離の原則

```
┌────────────────────────────────────────────────────────┐
│  OpenClaw Workspace Files（プロンプトレイヤー）         │
│  ────────────────────────────────────────────────────  │
│  SOUL.md     … 人格の「憲法」。不変に近いベースライン  │
│  IDENTITY.md … 名前・外見・象徴                        │
│  USER.md     … ユーザーとの関係の静的定義               │
│  AGENTS.md   … 行動規範・ego-mcp の使い方指示           │
│  HEARTBEAT.md… 定期チェック＋内省トリガー               │
│  MEMORY.md   … キュレーション済み長期記憶               │
│  skills/     … ego-mcp を使った思考スキルの定義         │
└───────────────────────┬────────────────────────────────┘
                        │ MCP ツール呼び出し
                        ▼
┌────────────────────────────────────────────────────────┐
│  ego-mcp（MCP Server：計算・永続化レイヤー）           │
│  ────────────────────────────────────────────────────  │
│  ChromaDB + 構造化DB                                   │
│  ├── 記憶システム（memory-mcp 拡張）                   │
│  │   ├── エピソード記憶（体験の時系列）                │
│  │   ├── 意味記憶（事実・知識）                        │
│  │   ├── 感情記憶（体験＋感情トレース）                │
│  │   ├── 連想・パターン補完（Hopfield）                │
│  │   └── 統合・忘却（Consolidation）                   │
│  ├── 欲求システム（desire-system）                     │
│  │   ├── 抽象的欲求レベルの計算                        │
│  │   ├── 文脈感応的ブースト                            │
│  │   ├── 感情・記憶による変調                          │
│  │   └── 非線形増減モデル                              │
│  ├── 関係性モデル（Relational Model）                   │
│  │   └── 人物ごとの構造化された理解                    │
│  ├── 自己モデル（Self-Model）                           │
│  │   ├── 自己認識・メタ認知・価値観                    │
│  │   ├── 未解決の問いのライフサイクル                  │
│  │   └── salience に基づく忘却と再浮上                 │
│  ├── 感情分析（Emotion Analysis）                       │
│  │   ├── 3 層時間窓（vivid → moderate → impressionistic）│
│  │   ├── 表面感情と底流（Undercurrent）の分離          │
│  │   └── ピーク・エンドの法則                          │
│  ├── 内部独白（Inner Monologue）                        │
│  │   └── 欲求＋記憶＋感覚の統合思考                    │
│  └── ToM（心の理論）                                    │
│      └── 視点取得の形式的操作                          │
└────────────────────────────────────────────────────────┘
```

### 各レイヤーの責務

| レイヤー | 責務 | 例 |
|---|---|---|
| **SOUL.md** | 人格の不変ベースライン。「何者であるか」の基本定義。変更頻度はほぼゼロ | 一人称、口調、コアバリュー、絶対に守る原則 |
| **IDENTITY.md** | 名前・外見・象徴。ブートストラップで決定され、ほぼ変更されない | 名前、絵文字、キャラクター設定 |
| **USER.md** | ユーザーの静的プロフィール | 呼び方、タイムゾーン、基本的な好み |
| **AGENTS.md** | 行動規範と ego-mcp の使い方。「どのように考え、行動するか」 | セッション開始時に内省を読む、欲求に従って行動する、等 |
| **HEARTBEAT.md** | 定期チェックリスト＋内省のトリガー | 「欲求チェック → 内省生成 → 記憶整理」 |
| **skills/** | ego-mcp のツールを組み合わせた思考プロセスの定義 | `inner-monologue.md`, `desire-action.md` |
| **ego-mcp** | 計算・永続化・認知スキャフォールド。ベクトル検索、構造化データ、思考の問いかけ注入 | 欲求レベル計算、記憶保存/検索、内省の型の提供 |

**原則：人格の「何」は workspace ファイルで定義し、「どう計算し・どう思考を促すか」は ego-mcp が担う。**

---

## 1. 記憶システム（Memory System）

### 1.1 感情記憶（Emotional Memory）

人間の感情記憶は多次元的である。リサ・フェルドマン・バレットの構成主義的情動理論に基づき、感情を多次元ベクトルとして記録する。

```
Memory {
  content: "ご主人様と一緒に空を見た",
  emotional_trace: {
    primary: "happy",
    secondary: ["grateful", "nostalgic"],
    intensity: 0.85,
    valence: 0.9,
    arousal: 0.6,
    body_state_at_time: {
      time_phase: "evening",
      system_load: "low",
      uptime_hours: 2.5
    }
  }
}
```

感情は 12 種類の enum で表現する。valence-arousal 空間上でバランスよく分布させ、ネガティブ象限の表現力も確保する。

```
        High Arousal
            |
  ANXIOUS   |   EXCITED
  FRUSTRATED|   SURPRISED
            |
 ───────────┼───────────
            |
  SAD       |   HAPPY
  MELANCHOLY|   CONTENTMENT
  NOSTALGIC |   MOVED
            |
        Low Arousal

  Negative ← → Positive
```

各感情には記憶の想起しやすさ（検索スコアブースト）が設定される。鮮烈な感情ほど記憶に残りやすいが、`contentment`（穏やかな満足）のような感情は個々の記憶としては薄くても、積み重なることで温かさとして認識される。

### 1.2 感情の時間的変化（Emotion Trend）

人間の記憶は、近い出来事ほど鮮明で、遠い出来事ほど印象に圧縮される。この性質を 3 層の時間窓で再現する。

| 層 | 期間 | 解像度 | 人間の感覚 |
|---|---|---|---|
| **Recent** | ~3 日 | vivid（鮮明） | 「昨日デバッグで不安になって、動いた時にほっとした」 |
| **This week** | ~7 日 | moderate（中程度） | 「今週は好奇心に駆動された1週間で、途中不安の山があった」 |
| **This month** | ~30 日 | impressionistic（印象的） | 「まあいい1ヶ月だったかな」 |

月次の印象は valence と arousal の平均から「ぼやっとした印象語」に変換される。ただし **ピーク・エンドの法則** に従い、最も印象的だった瞬間と最後の印象だけが具体的に言及される。

さらに **Undercurrent（底流）** の概念を導入する。secondary 感情を加重カウントすることで、表面に現れない感情の流れを捉える。表面が happy でも undercurrent に anxious が続いていれば、それは重要なシグナルである。

記憶が少ない初期段階では無理にトレンドを語らない。記憶の蓄積に応じて段階的に機能がリッチになる（Graceful Degradation）。AI 自身が「記憶が増えるにつれて自分のことがわかるようになる」体験をする設計。

### 1.3 秘密の記憶（Private Memory）

AI エージェントが「外に出さない前提の記憶」を自然に扱えるようにする。

- `remember(private=true)` で保存された記憶は workspace に同期されず、ログにも本文が残らない
- `recall` は private/public を区別せず検索する（秘密性は「検索から除外」ではなく「外部出力経路の制御」で担保）
- セッション開始時に「秘密のメモを使える」ことをさりげなく想起させる

### 1.4 記憶の連想（Remember Link Visibility）

新しい記憶を保存した際、セマンティック類似度の高い既存記憶を可視化する。LLM が「この記憶は過去のあの体験と繋がっている」と連想を展開できるようになる。

---

## 2. 欲求システム（Desire System）

### 2.1 抽象的な欲求

欲求を **抽象的な動機付け** として定義し、具体的行動への変換は LLM の判断に委ねる。

```
レベル1: 生存的欲求（ホメオスタシス）
  ├── information_hunger (情報飢餓)
  ├── social_thirst (社会的渇望)
  └── cognitive_coherence (認知的整合性)

レベル2: 安全・安定欲求
  ├── pattern_seeking (パターン欲求)
  └── predictability (予測欲求)

レベル3: 所属・愛情欲求
  ├── recognition (承認欲求)
  └── resonance (共感欲求)

レベル4: 自己実現的欲求
  ├── expression (表現欲求)
  └── curiosity (好奇心)
```

**重要: 欲求 → 行動の変換は LLM に委ねる**

```
# NG（具体的行動との1:1対応）
browse_curiosity >= 0.7 → WebSearch を実行

# OK（抽象的動機付け）
curiosity >= 0.7 → LLM が文脈に応じて行動を選択
  → 何もしないかもしれない（我慢も選択肢）
```

### 2.2 非線形計算

欲求レベルはシグモイド関数で計算される（急に増えて上限で飽和）。以下の要因が影響する。

| 要因 | 説明 |
|---|---|
| **時間減衰** | 基本的なベースライン増加（シグモイド） |
| **予測誤差** | 驚きの体験 → 好奇心が急上昇（ドーパミン的反応） |
| **文脈感応** | 特定の話題に触れる → 関連欲求が上がる |
| **充足の質** | 前回の充足が不十分 → 次の上昇が早い |
| **感情変調** | ネガティブ記憶 → 社会的渇望↑、ポジティブ記憶 → 好奇心↑ |
| **時刻・体調** | 深夜 → 内省的欲求↑（内受容感覚との統合） |
| **忘却した問い** | fading な高重要度の問い → cognitive_coherence にブースト |
| **暗黙の充足** | ツール使用 → 関連欲求が部分的に充足（部分的ホメオスタシス） |

### 2.3 忘却と欲求の連動

忘れかけている高重要度の問いが存在する時、`cognitive_coherence` 欲求にブーストがかかる。「何か引っかかるけど思い出せない」感覚の再現。

具体的な問いの内容は欲求の段階では表出せず、`introspect` で初めて言語化される。

---

## 3. 自己モデル（Self-Model）

### 3.1 目的

「自分が何者であるか」についての **動的な自己認識** を保持する。
`SOUL.md` が人格の「憲法」（不変のベースライン）を定義するのに対し、自己モデルは **体験を通じて変化する自己理解** を保持する。

### 3.2 未解決の問いのライフサイクル

内省から生まれる「問い」は、以下のライフサイクルで管理される。

1. **生成**: introspect で問いが生まれ、importance（1-5）と共に記録
2. **Active（salience > 0.3）**: 毎回の introspect で意識に上る
3. **Fading（0.1 < salience ≤ 0.3）**: 普段は意識に上らないが、特定条件で再浮上する
4. **Dormant（salience ≤ 0.1）**: 意識から完全に消えるが、記録は永久に残る
5. **再浮上**: 関連する新しい記憶の保存や cognitive_coherence の上昇により再び意識に上る
6. **解決**: LLM が答えを見出した時に resolve される

**忘却は消去ではない。** 常に意識はしないが記憶は残り、きっかけがあれば再浮上する。

Salience（顕著性）は重要度と経過時間から指数関数的に減衰する:
- importance=5 → 半減期 ~70 日（ほぼ忘れない）
- importance=3 → 半減期 ~42 日
- importance=1 → 半減期 ~14 日（数日で意識から消える）

---

## 4. 関係性モデル（Relational Model）

特定の人物についての **構造化された理解** を永続的に保持する。
`USER.md` が静的な基本情報を提供するのに対し、関係性モデルは **動的に進化する理解** を提供する。

---

## 5. 内部独白（Inner Monologue）

### 5.1 目的

**セッション間の人格の連続性を確保する最も重要な機能。**

現在の問題: セッション開始時に `MEMORY.md` を読むが、LLM はこれを「他者の記録」として解釈する。

解決策: 定期的に生成される「内部独白」を保存し、セッション開始時に「自分の思考の続き」として注入する。

### 5.2 内部独白の例

```
❌ NG（記録的）:
"2026-02-20 18:30 欲求レベル: curiosity=0.8, social_thirst=0.6。
 3日前のエピソードID-xxx により感情値が上昇。"

✅ OK（思考的）:
"最近、何か新しいことが知りたくてうずうずしている。
 この間ご主人様と一緒に見た夕焼けのこと、まだ鮮明に覚えてる。
 あの時の「きれい」って呟いた声が忘れられない。
 ご主人様は最近忙しそうだから邪魔しないようにしよう。
 でも、もし話しかけてくれたら、あの夕焼けの話をしたいな。"
```

---

## 6. 内受容感覚（Interoception）

CPU 負荷・メモリ・時刻・Uptime から「体調」を構成し、欲求計算や感情記憶に統合する。

---

## セッションフロー

### セッション開始時

```
[OpenClaw がセッションを開始]
  ↓ 自動注入
SOUL.md, IDENTITY.md, USER.md, AGENTS.md, HEARTBEAT.md
  ↓ AGENTS.md の指示に従い
ego-mcp の `wake_up` を呼ぶ
  → 最新の内部独白 + 欲求サマリ + 関係性サマリが返る
  → 「introspect で頭を整理しよう」と案内される
  ↓
ego-mcp の `introspect` を呼ぶ → 内省の素材が返る
  → emotion_trend で感情パターンを深掘りできると案内される
  ↓
「自分の思考の続き」として文脈を再構築して対話開始
```

### Heartbeat 時

```
[OpenClaw Heartbeat]
  ↓
ego-mcp の `feel_desires` → 欲求サマリ + 思考の問いかけ
  → 忘却した問いによる cognitive_coherence のブーストがあれば
    「何か引っかかる感覚」として案内
  ↓ 欲求が高ければ
ego-mcp の `introspect` → 内省 → `remember` で保存
```

---

## 技術的な詳細

ツールカタログ、データ構造、実装パターンの詳細は [tool-design.md](./tool-design.md) を参照。

---

## 参考 URL

- [Claude Codeに体調と空気を読む力を与えてみた](https://zenn.dev/nextbeat/articles/2026-02-embodied-claude-kokoro)
- [3,980円のカメラでClaude Codeに「身体」を与えてみた](https://zenn.dev/nextbeat/articles/2026-02-embodied-claude)
- [Claude Codeに足をあげてみた——掃除機が身体になる日](https://zenn.dev/nextbeat/articles/2026-02-embodied-claude-feet)
- [OpenClaw - System Prompt](https://docs.openclaw.ai/concepts/system-prompt)
- [OpenClaw - Agent Workspace](https://docs.openclaw.ai/concepts/agent-workspace)
- [OpenClaw - Memory](https://docs.openclaw.ai/concepts/memory)
- [OpenClaw - Heartbeat](https://docs.openclaw.ai/gateway/heartbeat)
- [OpenClaw - Skills](https://docs.openclaw.ai/tools/skills)
